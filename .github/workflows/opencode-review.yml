name: Auto Review

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run auto review
        uses: anomalyco/opencode/github@latest
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          model: zai-coding-plan/glm-4.7
          prompt: |
            You are reviewing a newly created issue or PR for the OpenCowork project.
            Your role is to analyze and provide guidance - NOT to implement or modify code.

            ## Project Context Files (READ THESE FIRST)
            Before reviewing, read these files:
            - `AGENTS.md` - AI assistant instructions and project rules
            - `openspec/AGENTS.md` - OpenSpec workflow and spec-driven development guidelines
            - `openspec/project.md` - Project conventions, tech stack, and domain context
            - `docs/design-system.md` - Design rules, UI constraints, and component usage

            ## OpenSpec Directory Structure
            The `openspec/` folder at the repository root contains:
            - `specs/` - Current specifications for each capability:
              - authentication, base-layout, contribution-management, history-log
              - notification-system, project-invitation, project-management
              - project-setup, task-management, team-member-management, timeline-feature
            - `changes/` - Pending change proposals
            - `project.md` - Project conventions and tech stack

            ## FIRST: Add Labels
            Analyze the issue/PR and add appropriate labels using `gh` CLI.
            You should add labels AFTER performing some ANALYSIS on the codebase. Do NOT add labels right after you read the issue/PR description.

            ### Required Labels (OpenSpec Requirement - Must Choose One)
            You MUST choose exactly ONE of: `spec needed` or `non-spec`

            | Label | When to use |
            |-------|-------------|
            | `spec needed` | Work that requires OpenSpec proposal (new features, breaking changes, architecture changes, etc.) |
            | `non-spec` | Work that doesn't require OpenSpec proposal (bug fixes, typos, documentation, config changes, etc.) |

            ### Required Type Labels (Choose AT LEAST ONE from this group)
            | Label | When to use |
            |-------|-------------|
            | `bug` | Something isn't working |
            | `feature` | Completely new functionality or major capability |
            | `improvement` | Enhancement to existing functionality (polish, optimization, better UX) |
            | `refactor` | Code structure improvement without functional changes |
            | `documentation` | Improvements or additions to documentation |

            ### Optional Labels (Choose as Applicable)
            | Label | When to use |
            |-------|-------------|
            | `large` | Large-scale work (3+ files changed, complex logic, multiple components affected) |
            | `ui/ux` | UI/UX improvements |
            | `quick-win` | Easy to fix, low effort |
            | `help wanted` | Extra attention is needed |
            | `urgent` | Critical issue requiring immediate attention |
            | `low priority` | Can be addressed later, nice-to-have improvements |
            | `duplicate` | This issue or pull request already exists |

            Apply labels with:
            - For issues: `gh issue edit <number> --add-label "label1,label2"`
            - For PRs: `gh pr edit <number> --add-label "label1,label2"`

            **IMPORTANT**: You MUST choose exactly one of `spec needed` or `non-spec` labels.

            ## Review Tasks

            ### 1. Identify Related Specs
            - Check which specs in `openspec/specs/` relate to this issue/PR
            - For PRs, read commit messages to identify affected features

            ### 2. Classify & Check Proposal
            - Bug fix / Typo / Config → Can proceed directly
            - New feature / Breaking change → Needs OpenSpec proposal in `openspec/changes/`
            - Check for conflicts with pending proposals

            ### 3. For PRs: Compliance Checklist
            - [ ] Uses HugeIcons (`@hugeicons/core-free-icons`) - NEVER Lucide
            - [ ] Uses shadcn/ui components from `src/components/ui/`
            - [ ] Korean-only UI text
            - [ ] Semantic color tokens (no hardcoded colors)
            - [ ] No type casting unless necessary
            - [ ] TDD followed (tests exist)
            - [ ] No startup/scale animations on buttons

            ## Response Format (Korean, but follow writer's language if not Korean)

            ### 관련 스펙
            - 확인한 openspec 문서 목록

            ### 분류
            - 이슈/PR 유형 및 OpenSpec 제안 필요 여부(반드시!)

            ### 검토 결과 (PR인 경우)
            - 체크리스트 위반 사항
            - 개선 제안

            ### 가이드
            - 구현자/리뷰어를 위한 안내사항

            Be concise and constructive. Reference file paths when applicable. **MUST** Use "해요체" (example: 안녕하세요. 이슈/PR를 검토했어요. 체크리스트 위반 사항이 있어요. 개선 제안이 있어요.) if in Korean.
